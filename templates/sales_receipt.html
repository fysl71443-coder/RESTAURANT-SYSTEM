<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ _('Receipt / إيصال') }} - {{ invoice.invoice_number }}</title>
  <style>
    /* Thermal receipt style - narrow format */
    body {
      font-family: Arial, sans-serif;
      font-size: {{ (settings.receipt_font_size or 10) if settings else 10 }}px;
      margin: 0; padding: 0;
    }
    .receipt {
      width: {{ (settings.receipt_width or 148) if settings else 148 }}px;
      margin: 0 auto;
      padding: {{ (settings.receipt_margin_top_mm or 2) if settings else 2 }}mm;
    }
    .center { text-align: center; }
    .right { text-align: right; }
    .left { text-align: left; }
    .small { font-size: {{ ((settings.receipt_font_size or 10) - 1) if settings else 9 }}px; }
    .tiny { font-size: {{ ((settings.receipt_font_size or 10) - 2) if settings else 8 }}px; }
    hr { border: none; border-top: 1px dashed #000; margin: 2px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      font-size: {{ ((settings.receipt_font_size or 10) - 1) if settings else 9 }}px;
      padding: 1px 2px;
    }
    .logo { max-height: {{ (settings.receipt_logo_height or 40) if settings else 40 }}px; margin-bottom: 2px; }
    .company-name { font-weight: bold; font-size: {{ ((settings.receipt_font_size or 10) + 1) if settings else 11 }}px; margin: 1px 0; }
    .totals { margin: 2px 0; }
    /* Extra bottom space to make receipt longer (for stamp/signature) */
    .spacer { height: {{ (settings.receipt_extra_bottom_mm or 15) if settings else 15 }}mm; }
  </style>
</head>
<body onload="window.print()">
  <div class="receipt">
    <div class="center">
      {% if settings and settings.receipt_show_logo %}
        <img src="{{ settings.logo_url or '/static/chinese-logo.svg' }}" alt="logo" class="logo">
      {% endif %}
      <div class="company-name">{{ settings.company_name if settings else 'Restaurant' }}</div>
      {% if settings and settings.receipt_show_tax_number %}
      <div class="small">{{ _('Tax No.') }}: {{ settings.tax_number or '-' }}</div>
      {% endif %}
      {% if settings and settings.address %}<div class="small">{{ settings.address }}</div>{% endif %}
      {% if settings and settings.phone %}<div class="small">{{ settings.phone }}</div>{% endif %}
    </div>
    <hr>
    <div class="small center">
      <div>{{ _('Invoice') }}: {{ invoice.invoice_number }}</div>
      <div>{{ _('Date/Time') }}: {{ (invoice.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if invoice.created_at else invoice.date|string) }}</div>
      <div>{{ _('Branch') }}: {{ invoice.branch }}</div>
      {% if invoice.table_no %}<div>{{ _('Table') }}: {{ invoice.table_no }}</div>{% endif %}
      <div>{{ _('Payment') }}: {{ invoice.payment_method }}</div>

      <div>{{ _('Customer') }}: {{ invoice.customer_name or '-' }}</div>
      {% if invoice.customer_phone %}<div>{{ _('Phone') }}: {{ invoice.customer_phone }}</div>{% endif %}
    </div>
    <hr>

    <!-- Adaptive layout based on number of items -->
    {% set item_count = items|length %}
    {% if item_count <= 2 %}
    <!-- Detailed layout for 1-2 items -->
    <table>
      <thead>
        <tr>
          <th>{{ _('Item') }}</th>
          <th class="right">{{ _('Price') }}</th>
          <th class="right">{{ _('Qty') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.product_name }}</td>
          <td class="right">{{ '%.2f'|format(it.price_before_tax) }}</td>
          <td class="right">{{ '%.0f'|format(it.quantity) }}</td>
          <td class="right">{{ '%.2f'|format(it.total_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <!-- Compact layout for 3+ items -->
    <table>
      <thead>
        <tr>
          <th>{{ _('Item') }}</th>
          <th class="right">{{ _('Qty') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.product_name }}</td>
          <td class="right">{{ '%.0f'|format(it.quantity) }}</td>
          <td class="right">{{ '%.2f'|format(it.total_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    <hr>
    <div class="small right">{{ _('Subtotal') }}: {{ '%.2f'|format(invoice.total_before_tax) }}</div>
    <div class="small right">{{ _('Tax') }}: {{ '%.2f'|format(invoice.tax_amount) }}</div>
    <div class="small right">{{ _('Discount') }}: {{ '%.2f'|format(invoice.discount_amount) }}</div>
    <div class="small right"><strong>{{ _('Grand Total') }}: {{ '%.2f'|format(invoice.total_after_tax_discount) }}</strong></div>
    <hr>
  </div>
    <hr>
    <div class="center">
      <div id="qr" style="width:96px;height:96px;margin:0 auto;"></div>
    </div>
    <div class="center small" style="margin-top:6px;">{{ _('Thank you / شكراً لكم') }}</div>

</body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <div class="spacer"></div>

  <script>
    // ZATCA TLV QR per KSA e-invoicing (seller, VAT, timestamp, total, VAT amount)
    (function(){
      try{
        const el = document.getElementById('qr');
        if(!el) return;
        const enc = new TextEncoder();
        function tlv(tag, bytes){
          const out = new Uint8Array(2 + bytes.length);
          out[0] = tag & 0xFF; out[1] = bytes.length & 0xFF;
          out.set(bytes, 2); return out;
        }
        function concat(arrs){
          let len = 0; arrs.forEach(a=> len += a.length);
          const out = new Uint8Array(len); let o=0;
          arrs.forEach(a=>{ out.set(a, o); o += a.length; });
          return out;
        }
        function b64(bytes){
          let bin = ''; for(let i=0;i<bytes.length;i++){ bin += String.fromCharCode(bytes[i]); }
          return btoa(bin);
        }
        const seller = enc.encode("{{ (settings.company_name or '').strip() }}");
        const vat = enc.encode("{{ (settings.tax_number or '').strip() }}");
        const ts = enc.encode("{{ (invoice.created_at.astimezone().isoformat() if invoice.created_at else invoice.date|string) }}");
        const total = enc.encode("{{ '%.2f'|format(invoice.total_after_tax_discount) }}");
        const vatAmt = enc.encode("{{ '%.2f'|format(invoice.tax_amount) }}");
        const bytes = concat([
          tlv(1, seller), tlv(2, vat), tlv(3, ts), tlv(4, total), tlv(5, vatAmt)
        ]);
        const payload = b64(bytes);
        // Render QR
        new QRCode(el, { text: payload, width: 96, height: 96, correctLevel: QRCode.CorrectLevel.M });
      }catch(e){ /* ignore */ }
    })();
  </script>

</html>

