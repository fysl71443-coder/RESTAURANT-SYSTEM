<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ _('Receipt / إيصال') }} - {{ invoice.invoice_number }}</title>
  <style>
    /* Thermal style based on Settings */
    body { font-family: Arial, sans-serif; font-size: {{ (settings.receipt_font_size or 12) if settings else 12 }}px; }
    .receipt { width: {{ '300' if (settings and settings.receipt_paper_width=='80') else '220' }}px; margin: 0 auto; }
    .center { text-align: center; }
    .right { text-align: right; }
    .small { font-size: {{ ((settings.receipt_font_size or 12) - 2) if settings else 10 }}px; }
    hr { border: none; border-top: 1px dashed #000; margin: 6px 0; }
    table { width: 100%; }
    th, td { font-size: {{ (settings.receipt_font_size or 12) if settings else 12 }}px; }
  </style>
</head>
<body onload="window.print()">
  <div class="receipt">
    <div class="center">
      {% if settings and settings.receipt_show_logo %}
        <img src="{{ settings.logo_url or '/static/chinese-logo.svg' }}" alt="logo" style="max-height:60px; margin-bottom:6px;">
      {% endif %}
      <div><strong>{{ settings.company_name if settings else 'Restaurant' }}</strong></div>
      {% if settings and settings.receipt_show_tax_number %}
      <div class="small">{{ _('Tax No.') }}: {{ settings.tax_number or '-' }}</div>
      {% endif %}
      <div class="small">{{ settings.address if settings else '' }}</div>
      <div class="small">{{ settings.phone if settings else '' }}</div>
    </div>
    <hr>
    <div class="small">
      <div>{{ _('Invoice') }}: {{ invoice.invoice_number }}</div>
      <div>{{ _('Date') }}: {{ invoice.date }}</div>
      <div>{{ _('Branch') }}: {{ invoice.branch }}</div>
      <div>{{ _('Customer') }}: {{ invoice.customer_name or '-' }}</div>
      {% if invoice.customer_phone %}<div>{{ _('Phone') }}: {{ invoice.customer_phone }}</div>{% endif %}
    </div>
    <hr>

    <table>
      <thead>
        <tr>
          <th>{{ _('Item') }}</th>
          <th class="right">{{ _('Qty') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.product_name }}</td>
          <td class="right">{{ '%.0f'|format(it.quantity) }}</td>
          <td class="right">{{ '%.2f'|format(it.total_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <hr>
    <div class="small right">{{ _('Subtotal') }}: {{ '%.2f'|format(invoice.total_before_tax) }}</div>
    <div class="small right">{{ _('Tax') }}: {{ '%.2f'|format(invoice.tax_amount) }}</div>
    <div class="small right">{{ _('Discount') }}: {{ '%.2f'|format(invoice.discount_amount) }}</div>
    <div class="small right"><strong>{{ _('Grand Total') }}: {{ '%.2f'|format(invoice.total_after_tax_discount) }}</strong></div>
    <hr>
  </div>
    <hr>
    <div class="center">
      <div id="qr" style="width:96px;height:96px;margin:0 auto;"></div>
    </div>
    <div class="center small" style="margin-top:6px;">{{ _('Thank you / شكراً لكم') }}</div>

</body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // ZATCA TLV QR per KSA e-invoicing (seller, VAT, timestamp, total, VAT amount)
    (function(){
      try{
        const el = document.getElementById('qr');
        if(!el) return;
        const enc = new TextEncoder();
        function tlv(tag, bytes){
          const out = new Uint8Array(2 + bytes.length);
          out[0] = tag & 0xFF; out[1] = bytes.length & 0xFF;
          out.set(bytes, 2); return out;
        }
        function concat(arrs){
          let len = 0; arrs.forEach(a=> len += a.length);
          const out = new Uint8Array(len); let o=0;
          arrs.forEach(a=>{ out.set(a, o); o += a.length; });
          return out;
        }
        function b64(bytes){
          let bin = ''; for(let i=0;i<bytes.length;i++){ bin += String.fromCharCode(bytes[i]); }
          return btoa(bin);
        }
        const seller = enc.encode("{{ (settings.company_name or '').strip() }}");
        const vat = enc.encode("{{ (settings.tax_number or '').strip() }}");
        const ts = enc.encode("{{ (invoice.created_at.isoformat() if invoice.created_at else invoice.date|string) }}");
        const total = enc.encode("{{ '%.2f'|format(invoice.total_after_tax_discount) }}");
        const vatAmt = enc.encode("{{ '%.2f'|format(invoice.tax_amount) }}");
        const bytes = concat([
          tlv(1, seller), tlv(2, vat), tlv(3, ts), tlv(4, total), tlv(5, vatAmt)
        ]);
        const payload = b64(bytes);
        // Render QR
        new QRCode(el, { text: payload, width: 96, height: 96, correctLevel: QRCode.CorrectLevel.M });
      }catch(e){ /* ignore */ }
    })();
  </script>

</html>

