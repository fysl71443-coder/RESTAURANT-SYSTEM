<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ _('Receipt / إيصال') }} - {{ invoice.invoice_number }}</title>
  <style>
    /* Thermal style based on Settings */
    body { font-family: Arial, sans-serif; font-size: {{ (settings.receipt_font_size or 12) if settings else 12 }}px; }
    .receipt { width: {{ '300' if (settings and settings.receipt_paper_width=='80') else '220' }}px; margin: 0 auto; }
    .center { text-align: center; }
    .right { text-align: right; }
    .small { font-size: {{ ((settings.receipt_font_size or 12) - 2) if settings else 10 }}px; }
    hr { border: none; border-top: 1px dashed #000; margin: 6px 0; }
    table { width: 100%; }
    th, td { font-size: {{ (settings.receipt_font_size or 12) if settings else 12 }}px; }
  </style>
</head>
<body onload="window.print()">
  <div class="receipt">
    <div class="center">
      {% if settings and settings.receipt_show_logo %}
        <img src="{{ settings.logo_url or '/static/chinese-logo.svg' }}" alt="logo" style="max-height:60px; margin-bottom:6px;">
      {% endif %}
      <div><strong>{{ settings.company_name if settings else 'Restaurant' }}</strong></div>
      {% if settings and settings.receipt_show_tax_number %}
      <div class="small">{{ _('Tax No.') }}: {{ settings.tax_number or '-' }}</div>
      {% endif %}
      <div class="small">{{ settings.address if settings else '' }}</div>
      <div class="small">{{ settings.phone if settings else '' }}</div>
    </div>
    <hr>
    <div class="small">
      <div>{{ _('Invoice') }}: {{ invoice.invoice_number }}</div>
      <div>{{ _('Date') }}: {{ invoice.date }}</div>
      <div>{{ _('Branch') }}: {{ invoice.branch }}</div>
      <div>{{ _('Customer') }}: {{ invoice.customer_name or '-' }}</div>
      {% if invoice.customer_phone %}<div>{{ _('Phone') }}: {{ invoice.customer_phone }}</div>{% endif %}
    </div>
    <hr>
    <div class="center">
      <canvas id="qr" width="120" height="120"></canvas>
    </div>
    <hr>
    <table>
      <thead>
        <tr>
          <th>{{ _('Item') }}</th>
          <th class="right">{{ _('Qty') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.product_name }}</td>
          <td class="right">{{ '%.0f'|format(it.quantity) }}</td>
          <td class="right">{{ '%.2f'|format(it.total_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <hr>
    <div class="small right">{{ _('Subtotal') }}: {{ '%.2f'|format(invoice.total_before_tax) }}</div>
    <div class="small right">{{ _('Tax') }}: {{ '%.2f'|format(invoice.tax_amount) }}</div>
    <div class="small right">{{ _('Discount') }}: {{ '%.2f'|format(invoice.discount_amount) }}</div>
    <div class="small right"><strong>{{ _('Grand Total') }}: {{ '%.2f'|format(invoice.total_after_tax_discount) }}</strong></div>
    <hr>
    <div class="center small">{{ _('Thank you / شكراً لكم') }}</div>
  </div>
</body>
  <script>
    // Simple placeholder QR drawing (not ISO-compliant); replace with proper QR lib if needed
    (function(){
      try{
        const canvas = document.getElementById('qr');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const payload = `NM={{ settings.company_name or '' }}|TAX={{ settings.tax_number or '' }}|INV={{ invoice.invoice_number }}|DT={{ invoice.date }}|AMT={{ '%.2f'|format(invoice.total_after_tax_discount) }}|VAT={{ '%.2f'|format(invoice.tax_amount) }}`;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#000';
        let x=0,y=0; const size=6; const W = canvas.width;
        for(let i=0;i<payload.length;i++){
          const code = payload.charCodeAt(i);
          for(let b=0;b<8;b++){
            const bit = (code >> b) & 1;
            if(bit){ ctx.fillRect(x, y, size, size); }
            x += size; if(x >= W){ x = 0; y += size; if(y >= W) break; }
          }
        }
      }catch(e){}
    })();
  </script>

</html>

