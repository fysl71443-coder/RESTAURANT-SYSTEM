<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ _('Receipt / إيصال') }} - {{ invoice.invoice_number }}</title>
  <style>
    /* Thermal receipt style - narrow format */
    body {
      font-family: Arial, sans-serif;
      font-size: {{ (settings.receipt_font_size or 10) if settings else 10 }}px;
      margin: 0; padding: 0;
    }
    .receipt {
      width: {{ (settings.receipt_width or 148) if settings else 148 }}px;
      margin: 0 auto;
      padding: {{ (settings.receipt_margin_top_mm or 2) if settings else 2 }}mm;
    }
    .center { text-align: center; }
    .right { text-align: right; }
    .left { text-align: left; }
    .small { font-size: {{ ((settings.receipt_font_size or 10) - 1) if settings else 9 }}px; }
    .tiny { font-size: {{ ((settings.receipt_font_size or 10) - 2) if settings else 8 }}px; }
    hr { border: none; border-top: 1px dashed #000; margin: 2px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      font-size: {{ ((settings.receipt_font_size or 10) - 1) if settings else 9 }}px;
      padding: 1px 2px;
    }
    .logo { max-height: {{ (settings.receipt_logo_height or 40) if settings else 40 }}px; margin-bottom: 2px; }
    .company-name { font-weight: bold; font-size: {{ ((settings.receipt_font_size or 10) + 1) if settings else 11 }}px; margin: 1px 0; }
    .totals { margin: 2px 0; }
    /* Extra bottom space to make receipt longer (for stamp/signature) */
    .spacer { height: {{ (settings.receipt_extra_bottom_mm or 15) if settings else 15 }}mm; }
  </style>
</head>
<body>
  <div class="receipt">
    <div class="center">
      {% if settings and (settings.receipt_show_logo|default(true)) %}
        <img id="logo" src="{{ settings.logo_url or url_for('static', filename='logo.svg') }}" alt="logo" class="logo">
      {% endif %}
      <div class="company-name">{{ settings.company_name if settings else 'Restaurant' }}</div>
      {% if settings and settings.receipt_show_tax_number %}
      <div class="small">{{ _('Tax No.') }}: {{ settings.tax_number or '-' }}</div>
      {% endif %}
      {% if settings and settings.address %}<div class="small">{{ settings.address }}</div>{% endif %}
      {% if settings and settings.phone %}<div class="small">{{ settings.phone }}</div>{% endif %}
    </div>
    <hr>
    <div class="small center">
      <div>{{ _('Invoice') }}: {{ invoice.invoice_number }}</div>
      <div>{{ _('Date/Time') }}: {{ (invoice.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if invoice.created_at else invoice.date|string) }}</div>
      <div>{{ _('Branch') }}: {{ invoice.branch }}</div>
      {% if invoice.table_no %}<div>{{ _('Table') }}: {{ invoice.table_no }}</div>{% endif %}
      <div>{{ _('Payment') }}: {{ invoice.payment_method }}</div>

      <div>{{ _('Customer') }}: {{ invoice.customer_name or '-' }}</div>
      {% if invoice.customer_phone %}<div>{{ _('Phone') }}: {{ invoice.customer_phone }}</div>{% endif %}
    </div>
    <hr>

    <!-- Adaptive layout based on number of items -->
    {% set item_count = items|length %}
    {% if item_count <= 2 %}
    <!-- Detailed layout for 1-2 items -->
    <table>
      <thead>
        <tr>
          <th>{{ _('Item') }}</th>
          <th class="right">{{ _('Price') }}</th>
          <th class="right">{{ _('Qty') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.product_name }}</td>
          <td class="right">{{ '%.2f'|format(it.price_before_tax) }}</td>
          <td class="right">{{ '%.0f'|format(it.quantity) }}</td>
          <td class="right">{{ '%.2f'|format(it.total_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <!-- Compact layout for 3+ items -->
    <table>
      <thead>
        <tr>
          <th>{{ _('Item') }}</th>
          <th class="right">{{ _('Qty') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.product_name }}</td>
          <td class="right">{{ '%.0f'|format(it.quantity) }}</td>
          <td class="right">{{ '%.2f'|format(it.total_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    <hr>
    <div class="small right">{{ _('Subtotal') }}: {{ '%.2f'|format(invoice.total_before_tax) }}</div>
    <div class="small right">{{ _('Tax') }}: {{ '%.2f'|format(invoice.tax_amount) }}</div>
    <div class="small right">{{ _('Discount') }}: {{ '%.2f'|format(invoice.discount_amount) }}</div>
    <div class="small right"><strong>{{ _('Grand Total') }}: {{ '%.2f'|format(invoice.total_after_tax_discount) }}</strong></div>
    <hr>
  </div>
    <hr>
    <div class="center">
      {% if qr_data_url %}
        <img src="{{ qr_data_url }}" alt="QR" width="96" height="96"/>
      {% else %}
        <div id="qr" style="width:96px;height:96px;margin:0 auto;"></div>
      {% endif %}
    </div>
    <div class="center small" style="margin-top:6px;">
      <div><strong>{{ _('THANK YOU FOR VISIT') }}</strong></div>
      <div>{{ _('Visit us again!') }}</div>
      <div>{{ _('Have a great day!') }}</div>
    </div>
    <script>
      (function(){
        function closeWindow(){ try{ window.close(); }catch(e){} }
        // Close immediately after the print dialog is closed (printed or cancelled)
        window.addEventListener('afterprint', ()=> setTimeout(closeWindow, 100));
        // Ensure logo and QR images are loaded before printing
        function triggerPrint(){
          // Guard to prevent double prints
          if (window.__printed__) return; window.__printed__ = true;
          requestAnimationFrame(()=> setTimeout(()=> window.print(), 20));
        }
        function readyToPrint(){
          const imgs = Array.from(document.images || []);
          const pending = imgs.filter(img => !img.complete);
          if (pending.length === 0) { triggerPrint(); }
          else {
            let left = pending.length;
            pending.forEach(img => img.addEventListener('load', ()=>{ left--; if(left===0) triggerPrint(); }, { once:true }));
            // Also add a max wait in case some images fail to load
            setTimeout(triggerPrint, 1200);
          }
        }
        if (document.readyState === 'complete' || document.readyState === 'interactive') readyToPrint();
        else document.addEventListener('DOMContentLoaded', readyToPrint);
        // Safety fallback: auto-close if afterprint is not fired
        setTimeout(closeWindow, 30000);
      })();
    </script>
</body>
{% if not qr_data_url %}
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <div class="spacer"></div>
  <script>
    (function(){
      try{
        const el = document.getElementById('qr');
        if(!el) return;
        // minimal client QR if server-side generation not available
        new QRCode(el, { text: '{{ invoice.invoice_number }}', width: 96, height: 96, correctLevel: QRCode.CorrectLevel.M });
      }catch(e){}
    })();
  </script>
{% endif %}

</html>

