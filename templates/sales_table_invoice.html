{% extends 'base.html' %}
{% block title %}{{ _('Sales - Table / المبيعات - الطاولة') }} #{{ table_no }} — {{ branch_label }}{% endblock %}
{% block content %}
<style>
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .cat-card { cursor: pointer; transition: transform .1s ease; }
  .cat-card:hover { transform: translateY(-2px); }
  .meal-card { cursor: pointer; }
  @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }
</style>
{% set back_url = url_for('sales_tables', branch_code=branch_code) %}

<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">{{ _('Table') }} #{{ table_no }} — {{ branch_label }}</h4>
      <small class="text-muted">{{ _('Select category then meal to add to invoice / اختر القسم ثم الوجبة') }}</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('sales_tables', branch_code=branch_code) }}">← {{ _('Back to Tables / رجوع للطاولات') }}</a>
    </div>
  </div>

  <div class="split">
    <!-- Right: Categories and Meals -->
    <div>
      <div class="mb-2">
        <h5 class="mb-2">{{ _('Main Categories / الأقسام الرئيسية') }}</h5>
        <div class="row g-2">
          {% for c in categories %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card cat-card p-2 h-100" onclick="selectCategory('{{ c }}', {{ loop.index0 }})">
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="fw-bold text-center">{{ c }}</div>
              </div>
            </div>
            <!-- Meals inside category card -->
            <!-- Inline holder removed: using modal approach for cleaner navigation -->


          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Left: Invoice Form -->
    <div>
      <div class="card">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">{{ _('Date / التاريخ') }}</label>
              <input id="date" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Invoice No. / رقم الفاتورة') }}</label>
              <input id="invNo" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-8">
              <label class="form-label">{{ _('Customer / العميل') }}</label>
              <input id="custName" type="text" class="form-control" placeholder="{{ _('Type name or phone...') }}">
              <div id="custList" class="list-group position-absolute w-50" style="z-index:10; display:none;"></div>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Customer Phone / هاتف العميل') }}</label>
              <input id="custPhone" type="text" class="form-control" placeholder="{{ _('Auto') }}" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Discount %% / نسبة الخصم %%') }}</label>
              <input id="discountPct" type="number" step="0.01" value="0" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Tax %% / الضريبة %%') }}</label>
              <input id="taxPct" type="number" step="0.01" value="{{ vat_rate }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Payment / طريقة الدفع') }}</label>
              <select id="payMethod" class="form-select">
                <option value="CASH">Cash</option>
                <option value="MADA">MADA</option>
                <option value="VISA">VISA</option>
                <option value="BANK">BANK</option>
              </select>
            </div>
          </div>

          <hr>

          <div>
            <h6 class="mb-2">{{ _('Items / الأصناف') }}</h6>
            <div id="itemsList" class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>{{ _('Meal') }}</th>
                    <th class="text-center" style="width:100px;">{{ _('Qty') }}</th>
                    <th class="text-end" style="width:140px;">{{ _('Unit') }}</th>
                    <th class="text-end" style="width:140px;">{{ _('Total') }}</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end gap-3">
              <div><strong>{{ _('Subtotal') }}</strong>: <span id="subtotal">0.00</span></div>
              <div><strong>{{ _('Tax') }}</strong>: <span id="tax">0.00</span></div>
              <div><strong>{{ _('Discount') }}</strong>: <span id="discount">0.00</span></div>
              <div><strong>{{ _('Grand Total') }}</strong>: <span id="grand">0.00</span></div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-danger" onclick="voidInvoice()">{{ _('Cancel Invoice / إلغاء الفاتورة') }}</button>
            <button class="btn btn-success" onclick="payAndPrint()">{{ _('Pay & Print / دفع + طباعة') }}</button>
          </div>
        </div>
      </div>
    </div>

<!-- One global modal placed once per page to avoid multiple instances -->
<div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="catModalTitle">{{ _('Items') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="catEmpty" class="alert alert-info d-none">{{ _('No items in this category yet / لا توجد أصناف في هذا القسم بعد') }}</div>
        <div class="row g-2" id="catGrid"></div>
      </div>
    </div>
  </div>
</div>

  </div>
</div>

<script>
  document.querySelectorAll('.cat-card').forEach((el, i)=>{
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectCategory(el.innerText.trim(), i);} });
    el.addEventListener('click', ()=> selectCategory(el.innerText.trim(), i));
    el.setAttribute('tabindex','0');
  });

  // Category name -> id map injected from server when available
  window.CAT_MAP = {{ cat_map_json | safe }};

  const meals = {{ meals_json | safe }};
  let currentCategory = null;
  const items = [];
  let custTimer = null;
  const custList = document.getElementById('custList');
  const custName = document.getElementById('custName');
  const custPhone = document.getElementById('custPhone');

  custName.addEventListener('input', () => {
    clearTimeout(custTimer);
    const q = custName.value.trim();
    if(!q){ custList.style.display='none'; return; }
    custTimer = setTimeout(async () => {
      let data = [];
      try{
        const res = await fetch(`/api/customers/lookup?q=${encodeURIComponent(q)}`, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        data = await res.json();
      }catch(e){ data = []; }
      custList.innerHTML = '';
      if(!Array.isArray(data) || !data.length){ custList.style.display='none'; return; }
      data.forEach(c => {
        const a = document.createElement('a');
        a.href = '#'; a.className = 'list-group-item list-group-item-action';
        a.textContent = `${c.name} (${c.phone||'-'}) — ${c.discount_percent}%`;
        a.onclick = (e)=>{ e.preventDefault(); selectCustomer(c); };
        custList.appendChild(a);
      });
      custList.style.display = 'block';
    }, 250);
  });

  function selectCustomer(c){
    custName.value = c.name;
    custPhone.value = c.phone || '';
    document.getElementById('discountPct').value = (c.discount_percent||0);
    custList.style.display='none';
    renderItems();
  }

  async function selectCategory(cat, idx){
    currentCategory = cat;
    // Open modal and populate with items in this category (from Menu API or fallback)
    const modalEl = document.getElementById('catModal');
    const modalTitle = document.getElementById('catModalTitle');
    const grid = document.getElementById('catGrid');
    const empty = document.getElementById('catEmpty');
    modalTitle.textContent = cat;
    grid.innerHTML = '';
    empty.classList.add('d-none');

    // Try menu category mapping first
    const catId = (window.CAT_MAP && window.CAT_MAP[cat]) ? window.CAT_MAP[cat] : null;
    let data = [];
    if(catId){
      try{
        const resp = await fetch(`/api/menu/${catId}/items`, { credentials: 'same-origin' });
        data = await resp.json();
      }catch(e){ data = []; }
    }

    if(catId && Array.isArray(data)){
      if(data.length === 0){ empty.classList.remove('d-none'); }
      data.forEach(m => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3';
        const price = Number(m.price || 0);
        const safeName = (m.name || '').replace(/`/g,'');
        col.innerHTML = `
          <div class="card meal-card h-100" onclick='addMenuItemClose(${m.meal_id}, ${JSON.stringify(safeName)}, ${price})'>
            <div class="card-body d-flex flex-column justify-content-between">
              <div class="fw-bold">${safeName}</div>
              <div class="text-muted">{{ _('Price') }}: ${price.toFixed(2)}</div>
            </div>
          </div>`;
        grid.appendChild(col);
      });
    } else {
      // Fallback: local meals filter
      const filtered = meals.filter(m => m.category === cat);
      if(filtered.length === 0){ empty.classList.remove('d-none'); }
      filtered.forEach(m => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3';
        const price = Number(m.price || 0);
        const safeName = (m.name || '').replace(/`/g,'');
        col.innerHTML = `
          <div class="card meal-card h-100" onclick="addItemClose(${m.id})">
            <div class="card-body d-flex flex-column justify-content-between">
              <div class="fw-bold">${safeName}</div>
              <div class="text-muted">{{ _('Price') }}: ${price.toFixed(2)}</div>
            </div>
          </div>`;
        grid.appendChild(col);
      });
    }

    // Reuse single modal instance to avoid double backdrops and stuck state
    if(!window.__catModalInstance){ window.__catModalInstance = new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true }); }
    window.__catModalInstance.show();
  }

  function addItemClose(mealId){ addItem(mealId); const m=document.getElementById('catModal'); const inst=bootstrap.Modal.getInstance(m); if(inst) inst.hide(); setTimeout(()=>{document.body.classList.remove('modal-open'); document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());}, 50); }
  function addMenuItemClose(mealId, name, unit){ addMenuItem(mealId, name, unit); const m=document.getElementById('catModal'); const inst=bootstrap.Modal.getInstance(m); if(inst) inst.hide(); setTimeout(()=>{document.body.classList.remove('modal-open'); document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());}, 50); }

  function addItem(mealId){
    const m = meals.find(x => x.id === mealId);
    if(!m) return;
    const existing = items.find(x => x.meal_id === m.id);
    if(existing){ existing.qty += 1; }
    else { items.push({ meal_id: m.id, name: m.name, unit: m.price, qty: 1 }); }
    renderItems();
  }

  // Add item using data from Menu API (fallback if meal not in global list)
  function addMenuItem(mealId, name, unit){
    const m = meals.find(x => x.id === mealId);
    if(m){ addItem(mealId); return; }
    const existing = items.find(x => x.meal_id === mealId);
    if(existing){ existing.qty += 1; }
    else { items.push({ meal_id: mealId, name: name, unit: unit, qty: 1 }); }
    renderItems();
  }

  function renderItems(){
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    let subtotal = 0;
    let tax = 0;
    const taxPct = parseFloat(document.getElementById('taxPct').value || '0');
    const discountPct = parseFloat(document.getElementById('discountPct').value || '0');

    items.forEach((it, idx) => {
      const lineSub = it.unit * it.qty;
      const lineTax = lineSub * (taxPct/100.0);
      subtotal += lineSub; tax += lineTax;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${it.name}</td>
        <td class="text-center"><input type="number" min="1" step="1" value="${it.qty}" class="form-control form-control-sm" onchange="changeQty(${idx}, this.value)"></td>
        <td class="text-end">${it.unit.toFixed(2)}</td>
        <td class="text-end">${(lineSub+lineTax).toFixed(2)}</td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})">×</button></td>`;
      body.appendChild(row);
    });

    const discountVal = (subtotal + tax) * (discountPct/100.0);
    const grand = (subtotal + tax) - discountVal;
    document.getElementById('subtotal').innerText = subtotal.toFixed(2);
    document.getElementById('tax').innerText = tax.toFixed(2);
    document.getElementById('discount').innerText = discountVal.toFixed(2);
    document.getElementById('grand').innerText = grand.toFixed(2);
  }

  function changeQty(idx, v){ items[idx].qty = parseFloat(v||'1'); renderItems(); }
  function removeItem(idx){ items.splice(idx,1); renderItems(); }

  async function payAndPrint(){
    if(items.length === 0){ alert('{{ _('Add at least one item / أضف عنصراً واحداً على الأقل') }}'); return; }
    const payload = {
      branch_code: '{{ branch_code }}',
      table_no: {{ table_no }},
      items: items.map(x => ({ meal_id: x.meal_id, qty: x.qty })),
      customer_name: document.getElementById('custName').value,
      customer_phone: document.getElementById('custPhone').value,
      discount_pct: parseFloat(document.getElementById('discountPct').value || '0'),
      tax_pct: parseFloat(document.getElementById('taxPct').value || '0'),
      payment_method: document.getElementById('payMethod').value
    };
    const token = document.querySelector('meta[name="csrf-token"]')?.content;
    const headers = { 'Content-Type': 'application/json' };
    if(token){ headers['X-CSRFToken'] = token; }
    let data;
    try{
      const checkoutUrl = {{ safe_url('api_sales_checkout') and ('\'' + safe_url('api_sales_checkout') + '\'') or 'null' }};
      if(!checkoutUrl){ alert('Missing checkout endpoint'); return; }
      const res = await fetch(checkoutUrl, {
        method: 'POST', headers, credentials:'same-origin', body: JSON.stringify(payload)
      });
      if(!res.ok){
        const txt = await res.text();
        alert(txt || ('HTTP '+res.status));
        return;
      }
      data = await res.json().catch(()=>null);
    }catch(e){ alert('Network error'); return; }
    if(!data || !data.ok){ alert((data && data.error) || 'Error'); return; }
    // Ensure any modal leftovers are removed
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());
    window.open(data.print_url, '_blank');
  }

  async function voidInvoice(){
    if(items.length === 0){ alert('{{ _('Invoice is already empty / لا توجد عناصر في الفاتورة') }}'); return; }
    const pwd = prompt("{{ _('Enter void password / أدخل كلمة مرور الإلغاء') }}");
    if(pwd===null) return; // cancelled prompt
    if(!pwd || pwd.trim().length===0){ alert("{{ _('Password required / كلمة المرور مطلوبة') }}"); return; }
    try{
      const resp = await fetch('{{ url_for('api_sales_void_check') }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pwd })
      });
      const data = await resp.json();
      if(!data.ok){ alert(data.error || '{{ _('Wrong password / كلمة المرور غير صحيحة') }}'); return; }
      // Clear invoice items and totals
      items.length = 0;
      renderItems();
      alert('{{ _('Invoice cancelled / تم إلغاء الفاتورة') }}');
    }catch(e){ alert('Error'); }
  }
</script>
{% endblock %}

