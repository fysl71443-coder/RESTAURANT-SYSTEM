{% extends 'base.html' %}
{% block title %}{{ _('POS / المبيعات') }}{% endblock %}
{% block content %}
<style>
:root{--pad:14px;--radius:14px}
.pos{display:grid;grid-template-columns:2fr 1fr;gap:20px}
.card{background:#fff;border-radius:var(--radius);box-shadow:0 6px 14px rgba(0,0,0,.06);padding:var(--pad)}
.sec-tabs{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:12px}
.sec-tab{position:relative;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;border:2px solid transparent;border-radius:var(--radius);background:#f0f2f5;font-weight:700;font-size:14px;cursor:pointer;transition:transform .1s, border-color .1s}
.sec-tab:hover{transform:scale(1.01)}
.sec-tab.active{border-color:#0d6efd; box-shadow:0 0 0 2px rgba(13,110,253,.15) inset}
.sec-badge{position:absolute;top:6px;right:6px;background:#0d6efd;color:#fff;border-radius:999px;font-size:12px;line-height:1;padding:4px 7px}
.sec-panel{display:none}
.sec-panel.active{display:block}
.meal-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.meal{border:1px solid #eee;border-radius:var(--radius);padding:12px;background:#fafafa}
.meal .thumb{aspect-ratio:4/3;background:#e9ecef;border-radius:10px;background-size:cover;background-position:center;margin-bottom:8px}
.item-row{display:grid;grid-template-columns:1fr 90px 90px 36px;gap:10px;align-items:center;border-bottom:1px dashed #e9ecef;padding:8px 0}
.total{font-weight:800;font-size:16px}
</style>
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5>🍽️ {{ branch }} — {{ _('#') }}{{ table_number }}</h5>
    <a class="btn btn-outline-secondary" href="{{ url_for('pos_home', branch_code=branch) }}">⬅ {{ _('Back / رجوع') }}</a>
  </div>
  <div class="pos">
    <div class="card">
      {% if not selected %}

      <div class="sec-tabs">
        {% for s in sections %}
          <a class="sec-tab" href="{{ url_for('pos_table', branch_code=branch, number=table_number, section_id=s.id) }}" style="background:#f5f6f7; color:#222; border:1px solid #e9ecef">
            <span>{{ s.name }}</span>
            <span class="sec-badge">{{ s.meals|length }}</span>
          </a>
        {% endfor %}
      </div>

      {% endif %}

      {% if selected %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">{{ selected.name }}</h6>
        <div class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('pos_table', branch_code=branch, number=table_number) }}">{{ _('All sections / جميع الأقسام') }}</a>
          <input type="search" class="form-control form-control-sm" style="max-width:220px" placeholder="{{ _('Search in section / بحث داخل القسم') }}" data-filter="selectedPanel"/>
        </div>
      </div>
      <div class="meal-grid" id="selectedPanel">
        {% for m in selected.meals %}
        <form method="post" action="{{ url_for('pos_add_item', invoice_id=invoice.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="meal_id" value="{{ m.id }}"/>
          <input type="hidden" name="price" value="{{ '%.2f'|format(m.price) }}"/>
          <div class="meal">
            <div class="fw-bold">{{ m.name }}</div>
            <div class="text-muted">{{ '%.2f'|format(m.price) }}</div>
            <div class="mt-2 d-flex gap-2">
              <input type="number" name="qty" class="form-control form-control-sm" step="0.01" placeholder="{{ _('Qty') }}" min="0.01"/>
              <button class="btn btn-sm btn-primary">+ {{ _('Add') }}</button>
            </div>
          </div>
        </form>
        {% else %}
          <div class="text-muted">{{ _('No items in this section yet / لا توجد عناصر في هذا القسم بعد') }}</div>
        {% endfor %}
      </div>
      <script>
      (function(){
        // Simple search filter for selected panel
        document.querySelectorAll('[data-filter]').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const container = document.getElementById(inp.getAttribute('data-filter'));
            const q = (inp.value||'').toLowerCase();
            if(!container) return;
            container.querySelectorAll('.meal').forEach(card=>{
              const name = card.querySelector('.fw-bold').textContent.toLowerCase();
              card.style.display = name.includes(q) ? '' : 'none';
            });
          });
        });
      })();
      </script>
      {% endif %}

    </div>
    <div class="card">
      <h6>{{ _('Invoice / الفاتورة') }}</h6>
      <div class="mb-2">
        <form method="post" action="{{ url_for('pos_set_customer', invoice_id=invoice.id) }}" class="row g-2 align-items-end">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="col-7">
            <label class="form-label form-label-sm">{{ _('Customer / العميل') }}</label>
            <select name="customer_id" class="form-select form-select-sm">
              <option value="0">{{ _('Cash customer (no discount) / عميل نقدي') }}</option>
              {% for c in customers %}
                <option value="{{ c.id }}" {% if invoice.customer_id==c.id %}selected{% endif %}>{{ c.name }} — {{ c.phone or '-' }} ({{ '%.2f'|format(c.discount_percent or 0) }}%)</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-5">
            <label class="form-label form-label-sm">{{ _('Payment Method / طريقة الدفع') }}</label>
            <select name="payment_method" class="form-select form-select-sm">
              <option {{ 'selected' if invoice.payment_method=='CASH' }} value="CASH">{{ _('CASH / نقداً') }}</option>
              <option {{ 'selected' if invoice.payment_method=='MADA' }} value="MADA">MADA</option>
              <option {{ 'selected' if invoice.payment_method=='VISA' }} value="VISA">VISA</option>
              <option {{ 'selected' if invoice.payment_method=='MASTERCARD' }} value="MASTERCARD">MASTERCARD</option>
              <option {{ 'selected' if invoice.payment_method=='BANK' }} value="BANK">BANK</option>
              <option {{ 'selected' if invoice.payment_method=='AKS' }} value="AKS">AKS</option>
              <option {{ 'selected' if invoice.payment_method=='GCC' }} value="GCC">GCC</option>
              <option {{ 'selected' if invoice.payment_method=='آجل' }} value="آجل">{{ _('Credit / آجل') }}</option>
            </select>
          </div>
          <div class="col-12">
            <button formaction="{{ url_for('pos_set_customer', invoice_id=invoice.id) }}" class="btn btn-sm btn-outline-secondary">{{ _('Apply / تطبيق') }}</button>
          </div>
        </form>
        {% if invoice.customer_name %}
          <div class="small text-muted mt-1">{{ invoice.customer_name }} — {{ invoice.customer_phone or '-' }}</div>
        {% endif %}
      </div>
      <div>
        {% for it in items %}
        <form method="post" action="{{ url_for('pos_update_item', invoice_id=invoice.id) }}" class="item-row">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

          <div>{{ it.product_name }}</div>
          <div><input type="number" class="form-control form-control-sm" name="qty" value="{{ '%.2f'|format(it.quantity) }}" step="0.01"/></div>
          <div class="text-end">{{ '%.2f'|format(it.total_price) }}</div>
          <input type="hidden" name="item_id" value="{{ it.id }}"/>
          <button formaction="{{ url_for('pos_remove_item', invoice_id=invoice.id) }}" class="btn btn-sm btn-danger">✕</button>
        </form>
        {% else %}
        <div class="text-muted">{{ _('No items / لا توجد عناصر') }}</div>
        {% endfor %}
      </div>
      <div class="mt-3">
        <div class="d-flex justify-content-between"><div>{{ _('Subtotal / المجموع') }}</div><div class="total">{{ '%.2f'|format(invoice.total_before_tax) }}</div></div>
        <div class="d-flex justify-content-between"><div>{{ _('VAT 15%% / الضريبة') }}</div><div class="total">{{ '%.2f'|format(invoice.tax_amount) }}</div></div>
        <div class="d-flex justify-content-between"><div>{{ _('Discount / الخصم') }}</div><div class="total">{{ '%.2f'|format(invoice.discount_amount) }}</div></div>
        <div class="d-flex justify-content-between"><div>{{ _('Total / الإجمالي') }}</div><div class="total">{{ '%.2f'|format(invoice.total_after_tax_discount) }}</div></div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <form method="post" action="{{ url_for('pos_finalize', invoice_id=invoice.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="action" value="pay_and_print"/>
          <button class="btn btn-success">{{ _('Pay & Print / دفع وطباعة الفاتورة') }}</button>
        </form>
        <form method="post" action="{{ url_for('pos_finalize', invoice_id=invoice.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="action" value="cancel"/>
          <button class="btn btn-outline-danger">{{ _('Cancel / إلغاء') }}</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

